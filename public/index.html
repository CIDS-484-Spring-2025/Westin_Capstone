<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Items and Users</title>

  <!-- Item Grid styling -->
  <style>
    body {
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        background-color: #a7a6b9;
        text-align: center;
    }

    #itemsGrid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        padding: 20px;
    }

    .item {
        flex: 1 1 calc(25% - 20px);
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 10px;
        background-color: #fff;
        padding: 15px;
        transition: transform 0.3s;
        max-width: 250px;
    }

    .item:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .item img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 10px;
    }

    .item h4 {
        margin: 10px 0;
    }

    .item p {
        color: #bfc1d6;
        margin: 5px 0;
    }

    .item button {
        background-color: #949be8;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 10px;
        width: 100%;
    }

    .item button:hover {
        background-color: #949be8;
    }
</style>  

</head>

<body>

  <!-- Search Input -->
  <input type="text" id="searchInput" placeholder="Search for items...">
  <button id="searchButton">Search</button>

  <h1 id='items list' style="
  color: #f03615;
  font-size: 38px;
  font-family: sans-serif;
">Available Items</h1>

<div id="itemsGrid"></div>


<h2>Create User</h2>
<form id="user-form">
  <input type="text" id="username" placeholder="Enter your username" required>
  <input type="email" id="email" placeholder="Enter your email" required>
  <button type="submit">Submit</button>
</form>
<p id="user-feedback"></p>

  <!-- Cart Button -->
  <button id="cartButton" style="
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 10px 20px;
  background-color: #f03615;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
  z-index: 1000;
  ">Cart</button>

  <!-- Cart Sidebar -->
  <div id="cartSidebar" style="
  position: fixed;
  top: 0;
  right: -300px;
  width: 300px;
  height: 100%;
  background-color: #f1f1f1;
  box-shadow: -2px 0 5px rgba(0,0,0,0.3);
  transition: right 0.3s ease;
  padding: 20px;
  box-sizing: border-box;
  z-index: 999;
  ">
  <h3>Your Cart</h3>
  <ul id="cartItems" style="list-style: none; padding: 0;"></ul>
  <button id="closeCart" style="
      margin-top: 20px;
      padding: 10px;
      background-color: #e95f46;
      color: #f1f1f1;
      border: none;
      border-radius: 5px;
      cursor: pointer;
  ">Close Cart</button>
  </div>


<script>

// Cart array to store selected items
let cart = [];

//user id for storing cart data
let currentUserId = null;

// Fetch items on page load
document.addEventListener('DOMContentLoaded', fetchItems);

async function fetchItems() {
  try {
    const response = await fetch('/api/items');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const items = await response.json();
    console.log('Items:', items); // Log the items

    const itemsGrid = document.getElementById('itemsGrid');
    itemsGrid.innerHTML = ''; // Clear previous items

    items.forEach(item => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'item';

      itemDiv.innerHTML = `
        <img src="${item.image_url || 'https://via.placeholder.com/150'}" alt="${item.item_name}">
        <h4>${item.item_name}</h4>
        <p>$${parseFloat(item.price).toFixed(2)}</p>
        <button onclick="addToCart(${item.item_id}, '${item.item_name}', ${parseFloat(item.price)}, '${item.image_url}')">Add to Cart</button>
      `;

      itemsGrid.appendChild(itemDiv);
    });

  } catch (error) {
    console.error('Error fetching items:', error);
    document.getElementById('itemsGrid').innerHTML = '<p>Failed to load items.</p>';
  }
}

// Function to add items to the users cart
function addToCart(item_id, item_name, price, image_url) {
    const existingItem = cart.find(cartItem => cartItem.id === item_id);
    if (existingItem) {
        existingItem.quantity += 1; // Increase quantity if item already in cart
    } else {
        cart.push({ item_id, item_name: name, price, image_url, quantity: 1 });
    }
    updateCartUI();
    alert(`${item_name} added to cart!`); // Popup confirmation
}

// Function to update the cart display in the sidebar
function updateCartUI() {
  const cartList = document.getElementById('cartItems');
  cartList.innerHTML = '';

  cart.forEach(item => {
    const li = document.createElement('li');
    li.innerHTML = `
      <img src="${item.image_url}" alt="${item.item_name}" style="width: 50px; height: 50px; border-radius: 5px; margin-right: 10px;">
      <strong>${item.item_name}</strong> - $${item.price.toFixed(2)} (x${item.quantity})
    `;
    cartList.appendChild(li);
  });
}

  // Initialize the items display on page load
  window.onload = fetchItems;

  // Handle user form submission
  document.getElementById('user-form').addEventListener('submit', async function (e) {
  e.preventDefault();

  const username = document.getElementById('username').value;
  const email = document.getElementById('email').value;

  try {
    const response = await fetch('/api/users', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, email })
    });

    if (response.ok) {
      const data = await response.json();
      currentUserId = data.userId; // Ensure currentUserId is set correctly
      document.getElementById('user-feedback').textContent = 'User created successfully!';
      fetchItems();
      fetchCart();
    } else {
      const data = await response.json();
      document.getElementById('user-feedback').textContent = data.message || data.error;
    }
  } catch (error) {
    console.error('Error creating user:', error);
  }
});

  // Fetch cart items
  async function fetchCart() {
    if (!currentUserId) return;

    try {
      const response = await fetch(`/api/cart/${currentUserId}`);
      const cartItems = await response.json();

      cart = cartItems; // Update the cart array with items from the database
      updateCartUI();
    } catch (error) {
      console.error('Error fetching cart:', error);
    }
  }

  // Search items
async function searchItems() {
  const searchTerm = document.getElementById('searchInput').value;
  console.log('Search term:', searchTerm); // Log the search term
  try {
    const response = await fetch(`/api/search?q=${encodeURIComponent(searchTerm)}`);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const items = await response.json();
    console.log('Search results:', items); // Log the search results

    const itemsGrid = document.getElementById('itemsGrid');
    itemsGrid.innerHTML = ''; // Clear previous items

    items.forEach(item => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'item';

      itemDiv.innerHTML = `
        <img src="${item.image_url || 'https://via.placeholder.com/150'}" alt="${item.item_name}">
        <h4>${item.item_name}</h4>
        <p>$${parseFloat(item.price).toFixed(2)}</p>
        <button onclick="addToCart(${item.item_id}, '${item.item_name}', ${parseFloat(item.price)}, '${item.image_url}')">Add to Cart</button>
      `;

      itemsGrid.appendChild(itemDiv);
    });

  } catch (error) {
    console.error('Error searching items:', error);
    document.getElementById('itemsGrid').innerHTML = '<p>Failed to load items.</p>';
  }
}


  // Open Cart Sidebar
  document.getElementById('cartButton').addEventListener('click', () => {
    document.getElementById('cartSidebar').style.right = '0';
  });

  // Close Cart Sidebar
  document.getElementById('closeCart').addEventListener('click', () => {
    document.getElementById('cartSidebar').style.right = '-300px';
  });

  // Search Button Click
  document.getElementById('searchButton').addEventListener('click', searchItems);

  </script>
</body>
</html>
